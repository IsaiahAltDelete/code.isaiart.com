<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --sidebar-bg: #f8f8f8;
            --tab-active-bg: #f0f0f0;
            --tab-active-border: #555555;
            --border-color: #e6e6e6;
            --button-bg: #555555;
            --button-hover: #333333;
            --button-text: white;
            --line-number-bg: #f8f8f8;
            --line-number-text: #888888;
            --editor-bg: #ffffff;
            --modal-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --font-mono: 'Poppins', monospace;
            --font-sans: 'Poppins', sans-serif;
            --transition-normal: all 0.2s ease;
            --radius: 6px;
        }

        .dark-mode {
            --bg-color: #2a2a2a;
            --text-color: #e0e0e0;
            --sidebar-bg: #333333;
            --tab-active-bg: #3a3a3a;
            --tab-active-border: #666666;
            --border-color: #444444;
            --button-bg: #666666;
            --button-hover: #888888;
            --button-text: white;
            --line-number-bg: #333333;
            --line-number-text: #999999;
            --editor-bg: #2a2a2a;
        }

        body {
            font-family: var(--font-sans);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition-normal);
            line-height: 1.5;
        }

        .header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 12px 24px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-color);
            box-shadow: var(--card-shadow);
            z-index: 10;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.025em;
            color: var(--button-bg);
        }

        .app-buttons {
            display: flex;
            gap: 12px;
        }

        .button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition-normal);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .button:hover {
            background-color: var(--button-hover);
            transform: translateY(-1px);
        }

        .toggle-switch {
            display: flex;
            align-items: center;
        }

        .toggle-label {
            margin-right: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: .3s ease;
            border-radius: 26px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s ease;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        input:checked + .slider {
            background-color: var(--button-bg);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        .sidebar {
            width: 220px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: var(--transition-normal);
        }

        .tabs {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .tab {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition-normal);
            font-size: 14px;
        }

        .tab.active {
            background-color: var(--tab-active-bg);
            font-weight: 600;
            border-left: 3px solid var(--tab-active-border);
            padding-left: 13px;
        }

        .tab:hover:not(.active) {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .dark-mode .tab:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .tab-close {
            opacity: 0.5;
            transition: var(--transition-normal);
            font-size: 16px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .tab:hover .tab-close {
            opacity: 0.8;
        }

        .tab-close:hover {
            background-color: rgba(0, 0, 0, 0.1);
            opacity: 1;
        }

        .dark-mode .tab-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .add-tab {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            font-weight: 600;
            transition: var(--transition-normal);
            color: var(--button-bg);
        }

        .add-tab:hover {
            background-color: rgba(66, 153, 225, 0.08);
        }

        .stats {
            padding: 12px;
            font-size: 12px;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
            color: var(--line-number-text);
            font-family: var(--font-mono);
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--editor-bg);
        }

        /* Custom scrollbars */
        .editor::-webkit-scrollbar, 
        .tabs::-webkit-scrollbar,
        .preview::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .editor::-webkit-scrollbar-track, 
        .tabs::-webkit-scrollbar-track,
        .preview::-webkit-scrollbar-track {
            background: transparent;
        }

        .editor::-webkit-scrollbar-thumb, 
        .tabs::-webkit-scrollbar-thumb,
        .preview::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.2);
            border-radius: 10px;
        }

        .editor::-webkit-scrollbar-thumb:hover, 
        .tabs::-webkit-scrollbar-thumb:hover,
        .preview::-webkit-scrollbar-thumb:hover {
            background: rgba(128, 128, 128, 0.4);
        }

        /* For Firefox */
        .editor, .tabs, .preview {
            scrollbar-width: thin;
            scrollbar-color: rgba(128, 128, 128, 0.2) transparent;
        }

        /* Search panel */
        .toolbar {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            background-color: var(--bg-color);
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
            padding: 0 16px;
        }

        .toolbar.visible {
            max-height: 100px;
            padding: 12px 16px;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-input, .replace-input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
            min-width: 200px;
            transition: var(--transition-normal);
        }

        .search-input:focus, .replace-input:focus {
            border-color: var(--button-bg);
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
        }

        .editor-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
            background-color: var(--editor-bg);
        }

        .line-numbers {
            padding: 16px 12px;
            text-align: right;
            background-color: var(--line-number-bg);
            color: var(--line-number-text);
            overflow-y: hidden;
            user-select: none;
            font-family: var(--font-mono);
            font-size: 14px;
            border-right: 1px solid var(--border-color);
        }

        .editor {
            flex: 1;
            padding: 16px;
            background-color: var(--editor-bg);
            color: var(--text-color);
            font-family: var(--font-mono);
            font-size: 14px;
            line-height: 1.6;
            overflow-y: auto;
            white-space: pre;
            tab-size: 4;
            border: none;
            outline: none;
            resize: none;
            transition: var(--transition-normal);
        }

        .preview {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 100;
            overflow: auto;
            padding: 32px;
            display: none;
        }

        .preview-close {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 8px 16px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: var(--transition-normal);
        }

        .preview-close:hover {
            background-color: var(--button-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background-color: var(--bg-color);
            padding: 24px;
            border-radius: var(--radius);
            width: 320px;
            box-shadow: var(--modal-shadow);
            transform: translateY(0);
            transition: transform 0.2s ease;
        }

        .modal-title {
            margin-top: 0;
            margin-bottom: 16px;
            font-weight: 600;
            font-size: 18px;
            color: var(--text-color);
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .modal-input {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
            transition: var(--transition-normal);
        }

        .modal-input:focus {
            border-color: var(--button-bg);
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="app-title"></div>
        <div class="app-buttons">
            <button class="button" id="search-toggle-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px;">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                Search
            </button>
            <button class="button" id="copy-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px;">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copy
            </button>
            <button class="button" id="paste-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px;">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                </svg>
                Paste
            </button>
            <button class="button" id="clear-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px;">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Clear
            </button>
            <button class="button" id="format-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px;">
                    <path d="M21 10H3M21 6H3M21 14H3M21 18H3"></path>
                </svg>
                Format
            </button>
            <button class="button" id="preview-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px;">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Preview
            </button>
            <button class="button" id="save-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px;">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Save
            </button>
            <div class="toggle-switch">
                <span class="toggle-label">Dark Mode</span>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="tabs" id="tabs">
                <!-- Tabs will be added here dynamically -->
            </div>
            <div class="add-tab" id="add-tab">+ New Tab</div>
            <div class="stats" id="stats">
                Lines: 0 | Words: 0 | Chars: 0
            </div>
        </div>

        <div class="editor-container">
            <div class="toolbar">
                <div class="search-container">
                    <input type="text" class="search-input" id="search-input" placeholder="Search...">
                    <button class="button" id="search-btn">Find</button>
                    <button class="button" id="search-next-btn">Next</button>
                </div>
                <div class="search-container">
                    <input type="text" class="replace-input" id="replace-input" placeholder="Replace...">
                    <button class="button" id="replace-btn">Replace</button>
                    <button class="button" id="replace-all-btn">Replace All</button>
                </div>
            </div>

            <div class="editor-wrapper">
                <div class="line-numbers" id="line-numbers"></div>
                <textarea class="editor" id="editor" spellcheck="false"></textarea>
            </div>
        </div>
    </div>

    <div class="preview" id="preview">
        <button class="preview-close" id="preview-close">Close Preview</button>
        <div id="preview-content"></div>
    </div>

    <div class="modal" id="tab-modal">
        <div class="modal-content">
            <h3 class="modal-title">New Tab</h3>
            <div class="modal-form">
                <input type="text" class="modal-input" id="tab-name" placeholder="Tab Name">
                <div class="modal-buttons">
                    <button class="button" id="cancel-tab">Cancel</button>
                    <button class="button" id="create-tab">Create</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="save-modal">
        <div class="modal-content">
            <h3 class="modal-title">Save File</h3>
            <div class="modal-form">
                <input type="text" class="modal-input" id="file-name" placeholder="File Name">
                <select class="modal-input" id="file-type">
                    <option value=".html">HTML</option>
                    <option value=".css">CSS</option>
                    <option value=".js">JavaScript</option>
                    <option value=".txt">Text</option>
                    <option value=".md">Markdown</option>
                    <option value=".json">JSON</option>
                </select>
                <div class="modal-buttons">
                    <button class="button" id="cancel-save">Cancel</button>
                    <button class="button" id="confirm-save">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="rename-modal">
        <div class="modal-content">
            <h3 class="modal-title">Rename Tab</h3>
            <div class="modal-form">
                <input type="text" class="modal-input" id="rename-input" placeholder="New Tab Name">
                <div class="modal-buttons">
                    <button class="button" id="cancel-rename">Cancel</button>
                    <button class="button" id="confirm-rename">Rename</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const themeToggle = document.getElementById('theme-toggle');
        const editor = document.getElementById('editor');
        const lineNumbers = document.getElementById('line-numbers');
        const stats = document.getElementById('stats');
        const tabs = document.getElementById('tabs');
        const addTab = document.getElementById('add-tab');
        const tabModal = document.getElementById('tab-modal');
        const tabName = document.getElementById('tab-name');
        const createTabButton = document.getElementById('create-tab');
        const cancelTabButton = document.getElementById('cancel-tab');
        const formatButton = document.getElementById('format-btn');
        const previewButton = document.getElementById('preview-btn');
        const previewContainer = document.getElementById('preview');
        const previewContent = document.getElementById('preview-content');
        const previewClose = document.getElementById('preview-close');
        const saveButton = document.getElementById('save-btn');
        const saveModal = document.getElementById('save-modal');
        const fileName = document.getElementById('file-name');
        const fileType = document.getElementById('file-type');
        const confirmSaveButton = document.getElementById('confirm-save');
        const cancelSaveButton = document.getElementById('cancel-save');
        const searchInput = document.getElementById('search-input');
        const replaceInput = document.getElementById('replace-input');
        const searchButton = document.getElementById('search-btn');
        const searchNextButton = document.getElementById('search-next-btn');
        const replaceButton = document.getElementById('replace-btn');
        const replaceAllButton = document.getElementById('replace-all-btn');
        const copyButton = document.getElementById('copy-btn');
        const pasteButton = document.getElementById('paste-btn');
        const clearButton = document.getElementById('clear-btn');

        // State variables
        let tabsData = [];
        let currentTabIndex = -1;
        let searchIndex = -1;
        let searchResults = [];

        // Initialize
        init();

        function init() {
            // Check local storage for theme
            const isDarkMode = localStorage.getItem('dark-mode') === 'true';
            themeToggle.checked = isDarkMode;
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            }

            // Check local storage for tabs
            const savedTabs = localStorage.getItem('editor-tabs');
            if (savedTabs) {
                tabsData = JSON.parse(savedTabs);
                renderTabs();
                if (tabsData.length > 0) {
                    switchToTab(0);
                } else {
                    createNewTab('Untitled');
                }
            } else {
                createNewTab('Untitled');
            }

            // Event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Theme toggle
            themeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('dark-mode', themeToggle.checked);
            });

            // Search toggle
            const searchToggleBtn = document.getElementById('search-toggle-btn');
            const toolbar = document.querySelector('.toolbar');
            searchToggleBtn.addEventListener('click', () => {
                toolbar.classList.toggle('visible');
            });

            // Editor events
            editor.addEventListener('input', () => {
                updateLineNumbers();
                updateStats();
                updateTabContent();
            });

            editor.addEventListener('scroll', () => {
                lineNumbers.scrollTop = editor.scrollTop;
            });

            editor.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    editor.value = editor.value.substring(0, start) + '    ' + editor.value.substring(end);
                    editor.selectionStart = editor.selectionEnd = start + 4;
                    updateLineNumbers();
                    updateTabContent();
                }
            });

            // Tab events
            addTab.addEventListener('click', () => {
                tabModal.style.display = 'flex';
                tabName.focus();
            });

            createTabButton.addEventListener('click', () => {
                const name = tabName.value.trim() || 'Untitled';
                createNewTab(name);
                tabModal.style.display = 'none';
                tabName.value = '';
            });

            cancelTabButton.addEventListener('click', () => {
                tabModal.style.display = 'none';
                tabName.value = '';
            });

            tabName.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    createTabButton.click();
                } else if (e.key === 'Escape') {
                    cancelTabButton.click();
                }
            });

            // Tab renaming
            const renameModal = document.getElementById('rename-modal');
            const renameInput = document.getElementById('rename-input');
            const confirmRenameButton = document.getElementById('confirm-rename');
            const cancelRenameButton = document.getElementById('cancel-rename');
            let tabToRename = -1;

            confirmRenameButton.addEventListener('click', () => {
                if (tabToRename >= 0 && tabToRename < tabsData.length) {
                    const newName = renameInput.value.trim() || tabsData[tabToRename].name;
                    tabsData[tabToRename].name = newName;
                    saveTabs();
                    renderTabs();
                }
                renameModal.style.display = 'none';
            });

            cancelRenameButton.addEventListener('click', () => {
                renameModal.style.display = 'none';
            });

            renameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    confirmRenameButton.click();
                } else if (e.key === 'Escape') {
                    cancelRenameButton.click();
                }
            });

            // Format button
            formatButton.addEventListener('click', formatCode);

            // Preview
            previewButton.addEventListener('click', showPreview);
            previewClose.addEventListener('click', () => {
                previewContainer.style.display = 'none';
            });

            // Save
            saveButton.addEventListener('click', () => {
                if (currentTabIndex >= 0) {
                    fileName.value = tabsData[currentTabIndex].name;
                    saveModal.style.display = 'flex';
                    fileName.focus();
                }
            });

            confirmSaveButton.addEventListener('click', saveFile);
            cancelSaveButton.addEventListener('click', () => {
                saveModal.style.display = 'none';
            });

            fileName.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    confirmSaveButton.click();
                } else if (e.key === 'Escape') {
                    cancelSaveButton.click();
                }
            });

            // Search and Replace
            searchButton.addEventListener('click', search);
            searchNextButton.addEventListener('click', searchNext);
            replaceButton.addEventListener('click', replace);
            replaceAllButton.addEventListener('click', replaceAll);

            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    searchButton.click();
                }
            });
            
            // Copy, Paste, Clear
            copyButton.addEventListener('click', () => {
                editor.select();
                document.execCommand('copy');
                // For modern browsers
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(editor.value);
                }
            });
            
            pasteButton.addEventListener('click', async () => {
                try {
                    // For modern browsers
                    if (navigator.clipboard && navigator.clipboard.readText) {
                        const text = await navigator.clipboard.readText();
                        const start = editor.selectionStart;
                        const end = editor.selectionEnd;
                        editor.value = editor.value.substring(0, start) + text + editor.value.substring(end);
                        editor.selectionStart = editor.selectionEnd = start + text.length;
                        updateLineNumbers();
                        updateStats();
                        updateTabContent();
                    } else {
                        editor.focus();
                        document.execCommand('paste');
                    }
                } catch (err) {
                    console.error('Failed to read clipboard contents:', err);
                    alert('Could not access clipboard. Please use keyboard shortcut Ctrl+V or Cmd+V instead.');
                }
            });
            
            clearButton.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all content?')) {
                    editor.value = '';
                    updateLineNumbers();
                    updateStats();
                    updateTabContent();
                }
            });
        }

        function createNewTab(name) {
            const tab = {
                name: name,
                content: ''
            };
            tabsData.push(tab);
            saveTabs();
            renderTabs();
            switchToTab(tabsData.length - 1);
        }

        function renderTabs() {
            tabs.innerHTML = '';
            tabsData.forEach((tab, index) => {
                const tabElement = document.createElement('div');
                tabElement.className = 'tab' + (index === currentTabIndex ? ' active' : '');
                tabElement.innerHTML = `
                    <span class="tab-name">${tab.name}</span>
                    <span class="tab-close">Ã—</span>
                `;
                
                // Handle tab click
                tabElement.addEventListener('click', (e) => {
                    if (e.target.className === 'tab-close') {
                        closeTab(index);
                    } else {
                        switchToTab(index);
                    }
                });
                
                // Handle tab double-click for renaming
                tabElement.querySelector('.tab-name').addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    showRenameModal(index);
                });
                
                tabs.appendChild(tabElement);
            });
        }

        function showRenameModal(index) {
            if (index < 0 || index >= tabsData.length) return;
            
            const renameModal = document.getElementById('rename-modal');
            const renameInput = document.getElementById('rename-input');
            
            tabToRename = index;
            renameInput.value = tabsData[index].name;
            renameModal.style.display = 'flex';
            renameInput.focus();
            renameInput.select();
        }

        function switchToTab(index) {
            if (index < 0 || index >= tabsData.length) return;
            currentTabIndex = index;
            editor.value = tabsData[index].content;
            updateLineNumbers();
            updateStats();
            renderTabs();
        }

        function closeTab(index) {
            if (tabsData.length === 1) {
                tabsData[0] = { name: 'Untitled', content: '' };
                editor.value = '';
                updateLineNumbers();
                updateStats();
                renderTabs();
            } else {
                tabsData.splice(index, 1);
                if (currentTabIndex === index) {
                    currentTabIndex = Math.min(index, tabsData.length - 1);
                } else if (currentTabIndex > index) {
                    currentTabIndex--;
                }
                saveTabs();
                renderTabs();
                switchToTab(currentTabIndex);
            }
        }

        function updateTabContent() {
            if (currentTabIndex >= 0) {
                tabsData[currentTabIndex].content = editor.value;
                saveTabs();
            }
        }

        function saveTabs() {
            localStorage.setItem('editor-tabs', JSON.stringify(tabsData));
        }

        function updateLineNumbers() {
            const lines = editor.value.split('\n');
            lineNumbers.innerHTML = '';
            for (let i = 0; i < lines.length; i++) {
                lineNumbers.innerHTML += (i + 1) + '<br>';
            }
        }

        function updateStats() {
            const text = editor.value;
            const lines = text.split('\n').length;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const chars = text.length;
            stats.textContent = `Lines: ${lines} | Words: ${words} | Chars: ${chars}`;
        }

        function formatCode() {
            try {
                const content = editor.value;
                let formatted = '';
                
                // Simple formatter based on indentation
                if (tabsData[currentTabIndex].name.endsWith('.html') || content.includes('<')) {
                    // HTML formatting
                    formatted = formatHTML(content);
                } else if (tabsData[currentTabIndex].name.endsWith('.css') || content.includes('{') && content.includes('}')) {
                    // CSS formatting
                    formatted = formatCSS(content);
                } else if (tabsData[currentTabIndex].name.endsWith('.js') || content.includes('function')) {
                    // JS formatting
                    formatted = formatJS(content);
                } else {
                    // Basic text formatting
                    formatted = content.split('\n').map(line => line.trim()).join('\n');
                }
                
                editor.value = formatted;
                updateLineNumbers();
                updateTabContent();
            } catch (error) {
                console.error('Formatting error:', error);
            }
        }

        function formatHTML(html) {
            let formatted = '';
            let indent = 0;
            const lines = html.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;
                
                // Check if this line is a closing tag
                if (line.startsWith('</')) {
                    indent = Math.max(0, indent - 4);
                }
                
                // Add indentation
                formatted += ' '.repeat(indent) + line + '\n';
                
                // Check if this line is an opening tag and not a self-closing tag
                if (line.includes('<') && !line.includes('</') && 
                    !line.endsWith('/>') && !line.match(/<(img|br|hr|input|link|meta)/i)) {
                    indent += 4;
                }
            }
            
            return formatted;
        }

        function formatCSS(css) {
            let formatted = '';
            let indent = 0;
            const lines = css.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;
                
                // Check for opening bracket
                if (line.includes('{')) {
                    formatted += ' '.repeat(indent) + line + '\n';
                    indent += 4;
                }
                // Check for closing bracket
                else if (line.includes('}')) {
                    indent = Math.max(0, indent - 4);
                    formatted += ' '.repeat(indent) + line + '\n';
                }
                // Regular property
                else {
                    formatted += ' '.repeat(indent) + line + '\n';
                }
            }
            
            return formatted;
        }

        function formatJS(js) {
            let formatted = '';
            let indent = 0;
            const lines = js.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;
                
                // Check for opening bracket
                if (line.includes('{')) {
                    formatted += ' '.repeat(indent) + line + '\n';
                    indent += 4;
                }
                // Check for closing bracket
                else if (line.includes('}')) {
                    indent = Math.max(0, indent - 4);
                    formatted += ' '.repeat(indent) + line + '\n';
                }
                // Regular line
                else {
                    formatted += ' '.repeat(indent) + line + '\n';
                }
            }
            
            return formatted;
        }

        function showPreview() {
            const content = editor.value;
            previewContent.innerHTML = content;
            previewContainer.style.display = 'block';
        }

        function saveFile() {
            if (currentTabIndex < 0) return;
            
            const name = fileName.value.trim() || tabsData[currentTabIndex].name;
            const extension = fileType.value;
            const fullName = name.endsWith(extension) ? name : name + extension;
            const content = editor.value;
            
            // Create blob and download
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fullName;
            a.click();
            
            // Update tab name if needed
            if (fullName !== tabsData[currentTabIndex].name) {
                tabsData[currentTabIndex].name = fullName;
                saveTabs();
                renderTabs();
            }
            
            saveModal.style.display = 'none';
        }

        function search() {
            const searchTerm = searchInput.value;
            if (!searchTerm) return;
            
            const content = editor.value;
            searchResults = [];
            let index = content.indexOf(searchTerm);
            
            while (index !== -1) {
                searchResults.push(index);
                index = content.indexOf(searchTerm, index + 1);
            }
            
            if (searchResults.length > 0) {
                searchIndex = 0;
                highlightSearch(searchResults[0], searchTerm.length);
            }
        }

        function searchNext() {
            if (searchResults.length === 0) {
                search();
                return;
            }
            
            searchIndex = (searchIndex + 1) % searchResults.length;
            highlightSearch(searchResults[searchIndex], searchInput.value.length);
        }

        function highlightSearch(index, length) {
            editor.focus();
            editor.setSelectionRange(index, index + length);
            
            // Scroll to view if needed
            const lineStart = editor.value.lastIndexOf('\n', index) + 1;
            const lineEnd = editor.value.indexOf('\n', index);
            const lineNumber = editor.value.substr(0, lineStart).split('\n').length;
            
            // Scroll to position
            const lineHeight = 21; // Approximate line height
            const scrollTop = (lineNumber - 3) * lineHeight;
            if (scrollTop > 0) {
                editor.scrollTop = scrollTop;
            }
        }

        function replace() {
            if (searchResults.length === 0 || searchIndex === -1) {
                search();
                return;
            }
            
            const searchTerm = searchInput.value;
            const replaceTerm = replaceInput.value;
            
            if (!searchTerm) return;
            
            const startPos = searchResults[searchIndex];
            const endPos = startPos + searchTerm.length;
            
            // Replace the text
            editor.value = editor.value.substring(0, startPos) + replaceTerm + editor.value.substring(endPos);
            
            // Update everything
            updateTabContent();
            updateLineNumbers();
            updateStats();
            
            // Re-search since text has changed
            search();
        }

        function replaceAll() {
            const searchTerm = searchInput.value;
            const replaceTerm = replaceInput.value;
            
            if (!searchTerm) return;
            
            // Replace all occurrences
            editor.value = editor.value.split(searchTerm).join(replaceTerm);
            
            // Update everything
            updateTabContent();
            updateLineNumbers();
            updateStats();
            
            // Clear search results
            searchResults = [];
            searchIndex = -1;
        }
    </script>
</body>
</html>